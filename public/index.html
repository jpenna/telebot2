<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Telebot 2</title>
</head>
<body>

  <div class="chat_list">
    <ul id="chats">

    </ul>
  </div>

  <div class="chat_room">
    <div class="chat_info">

    </div>
    <div class="chat_messages">

    </div>
    <div class="chat_input">

      <form id="inputForm">
        <input type="text" name="message" autocomplete="off"/>
      </form>

    </div>
  </div>


</body>

<script src="/socket.io/socket.io.js"></script>
<script src="/script/lib/moment/moment-with-locales.min.js"></script>
<script>
  const socket = io.connect();

  socket.on('newMessage', (data) => {
    insertMessage(data.author, data.message);
  });

  socket.on('newChat', (data) => {
    insertChat(data.name);
  });

  socket.on('populateChats', (data) => {
    const chats = data.chats;

    if (!chats) {
      console.log('You are alone, Mister! No chats for you. SHAME on your loneliness!');
    }

    chats.forEach((chat, key) => {
      insertChat(chat.fullname);
    });

    chats[0].messages.forEach((msg, key) => {
      insertMessage(`${moment(msg.sentAt).locale('pt-br').format('HH:mm')} - ${msg.author}`, msg.message);
    })
  })

  document.getElementById('inputForm').addEventListener('submit', (e) => {
    e.preventDefault();

    const messageInput = document.querySelector('input[name="message"]');
    const message = messageInput.value;
    if (!message) {
      return;
    }

    insertMessage('Telebot', message);

    socket.emit('sendTelegram', message, () => {
      messageInput.value = '';
    });

  });


  function insertMessage(author, message) {
    const chat_messages = document.querySelector('.chat_messages');

    const newMessage = document.createElement('div');
    newMessage.appendChild(document.createTextNode(`${author}: ${message}`));
    chat_messages.appendChild(newMessage);
  }

  function insertChat(name) {
    const chat_list = document.querySelector('.chat_list');

    const newChat = document.createElement('button');
    newChat.appendChild(document.createTextNode(`${name}`));
    chat_list.appendChild(newChat);
  }
</script>

</html>
